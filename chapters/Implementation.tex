\section{Implementation}

This section outlines the extension incorporated into SeisSol required for the implementation of \ac{ITM}. The implemenetation has been designed in a generic way,
ensuring that the current code can be easily reused for future experiments. \\

As described in the earlier sections, we need to change the material properties of the medium to induce a time-reversed wave. This is achieved by modifying the Lam\'{e}
parameters and density from $t_{ITM}^-$ to $t_{ITM}^+$ as per the reflection required. As discussed earlier, we need a change in impedance to ensure that there is a reflected
component of the waves(~\parencite[Sec 9.8]{leveque_2002}). So, we show the different ways of achieving this change in impedance. \\

\subsection{Reflecting both P- and S- waves by changing their velocities}

The first approach is to change the velocities of both P- and S- waves. This is achieved by changing the Lam\'{e} parameters $\lambda$ and $\mu$ as per the following equations from $t_{ITM}^-$ to $t_{ITM}^+$

\begin{align}
    \begin{split}
        \hat{\lambda} &= n^2 \lambda \\
        \hat{\mu} &= n^2 \mu \\
        \hat{\rho} &= \rho .
    \end{split}
\end{align}

This changes the velocities and impedances of both the waves during the duration of the \ac{ITM} as

\begin{align}
    \begin{split}
        \hat{v}_p &= n v_p \\
        \hat{v}_s &= n v_s \\
        \hat{Z}_p &= n Z_p \\
        \hat{Z}_s &= n Z_s .
    \end{split}
\end{align}

\subsection{Reflecting both P- and S- waves by keeping their velocities constant}
Here, we keep the velocities of both P- and S- waves constant but yet change their impedance by manipulating density along with the Lame\`{e} parameters. This is achieved by the following manipulation of the material properties

\begin{align}
    \begin{split}
        \hat{\lambda} &= n \lambda\\
        \hat{\mu} &= n \mu\\
        \hat{\rho} &= \frac{\rho} {n} .
    \end{split}
\end{align}

This changes the impedances of both the waves during the duration of the \ac{ITM} as

\begin{align}
    \begin{split}
        \hat{v}_p &= v_p \\
        \hat{v}_s &= v_s \\
        \hat{Z}_p &= n Z_p \\
        \hat{Z}_s &= n Z_s .
    \end{split}
\end{align}

\subsection{Reflecting only P- waves}

This is achieved by changing the Lam\'{e} parameter $\lambda$ and keeping $\mu$ constant from $t_{ITM}^-$ to $t_{ITM}^+$

\begin{align}
    \begin{split}
        \hat{\lambda} &= n \lambda \\
        \hat{\mu} &= \mu \\
        \hat{\rho} &= \rho .
    \end{split}
\end{align}

The scaling of velocities and impedances of the P- wave in this case are not straightforward 

\begin{align}
    \begin{split}
        \hat{v}_p = \sqrt{\frac{\hat{\lambda} + 2 \mu}{\rho}} \\
        \hat{Z}_p = \sqrt{\rho\left(\hat{\lambda} + 2 \mu \right)} \\
        \hat{v}_s = v_s \\
        \hat{Z}_s = Z_s . 
    \end{split}
\end{align}

Even though the scaling is not clear and straightforward with a direct relation with the earlier cases, we can still see that the impedance of the P- wave is different during the \ac{ITM}
which ensures that there is a reflected component for that wave keeping the S-wave unaffected. \\

\subsection{Reflecting only S- waves}

The reflection of S-waves by ensuring there is no reflection in P-waves is the trickiest part. There is no one correct way to do this but the one that worked for us
the best is the follows

\begin{align}
    \begin{split}
        \hat{\lambda} &= \frac{\lambda + 2 \mu}{n} -  2n \mu\\
        \hat{\mu} &= n \mu \\
        \hat{\rho} &= n \rho .
    \end{split}
\end{align}

The scaling of velocities and impedances of both the waves in this case are 

\begin{align}
    \begin{split}
        \hat{v}_p = \frac{v_p}{n} \\
        \hat{Z}_p = Z_p \\
        \hat{v}_s = v_s \\
        \hat{Z}_s = n Z_s .
    \end{split}
\end{align}

This case is a demonstration where the speed of the wave can change and yet, there will be no reflection of the wave in time when the impedance is constant.
Similarly, for the S-wave, even though there is no change in the wave speed, the change of impedance causes the reflection of the wave in time. \\

\subsection{Time Step}
\ac{CFL} condition is generally used to limit the maximum time step an element might have for explicit time integration schemes. These are influenced by the order
of convergence, occuring wave speeds and size of the considered element. \\

SeisSol uses \ac{LTS} schemes for explicit time-stepping. The \ac{LTS} scheme uses different time steps for different elements in our mesh. 
SeisSol clustures the elements to reduce the heterogeneity of the \ac{LTS} algorithm. The clusters summarize the elements in the computational domain advancing
with a common time step. We need to modify this common time step of all the clusters accordingly when the material properties are changed as that changes the 
speeds of propagation of the waves. For more details on \ac{LTS} schemes, interested readers are referred to ~\parencite{breuer}, ~\parencite{dumbser2007arbitrary},
~\parencite{castro2009space}, ~\parencite{rietmann2015loadbalanced}, ~\parencite{seny2014efficient}, ~\parencite{Gassner2008}, ~\parencite{andrew}, 
~\parencite{SCHLEGEL2009345}. \\

It the cluster $i$ has the time step $dt_i$, this is how the time step is modified for the \ac{ITM} duration in different cases

\subsubsection{Reflecting both the P- and S- waves by changing their velocities or just the P- wave}
This this case, we just need to scale down the time step by the same factor as the velocities of the waves. So, the time step for the cluster $i$ is scaled as

\begin{equation}
    \hat{dt}_i = \frac{dt_i}{n} ,
\end{equation}

where $\hat{dt}_i$ is the time step of cluster $i$ during the \ac{ITM} duration. \\

Here, we notice that in case of reflecting just the P- wave, we still scale by the factor $n$ even though the velocity is not exactly scaled by $n$. This is
to maintain simplicity in the code as the scaling of the velocities of just the P- wave is not straightforward. Nevertheless, \ac{CFL} condition is still 
satisfied with scaling. \\

\subsubsection{Reflecting both the P- and S- waves by keeping their velocities constant}
In this case, we do not need to scale down the time step by the factor $n$ as the velocity is not scaled here but only the impedance of the waves. 
So, the time step for the clusters are not scaled and kept the same in this scenario.

\begin{equation}
    \hat{dt}_i = dt_i .
\end{equation}

\subsubsection{Reflecting only the S- wave}
Here, we need to scale up the time step by the factor $n$ as the velocity of the P- wave is scaled down by the factor $n$ to ensure that the simulation still follows
\ac{CFL} condition in case of a scaling factor less than 1 i.e., $n < 1$. So, the time step for the cluster $i$ is scaled as

\begin{equation}
    \hat{dt}_i = n dt_i .
\end{equation}